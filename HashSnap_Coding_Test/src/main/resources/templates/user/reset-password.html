<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
  <meta charset="UTF-8">
  <title>비밀번호 재설정</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    .hidden {
      display: none;
    }

    input[type="text"], input[type="password"], input[type="email"] {
      padding: 8px;
      width: 250px;
    }

    button {
      padding: 8px 16px;
      cursor: pointer;
    }

    .status {
      margin-top: 10px;
      font-weight: bold;
      color: green;
    }

    .error {
      color: red;
    }
  </style>
</head>
<body>

  <h2>비밀번호 재설정</h2>

  <form th:action="@{/user/email/verification-requests}" method="post" id="emailForm">
    <div class="form-group">
      <label for="email">이메일 주소:</label><br>
      <input type="email" id="email" name="email" required />
    </div>
    <button type="submit">인증번호 받기</button>
  </form>

  <div id="code-section" class="hidden">
    <form th:action="@{/user/email/verification}" method="get" id="verifyForm">
      <div class="form-group">
        <label for="code">인증번호:</label><br>
        <input type="text" id="code" name="code" required />
        <input type="hidden" name="email" id="verifyEmail" />
      </div>
      <button type="submit">인증번호 확인</button>
    </form>
    <div id="verify-status" class="status"></div>
  </div>

  <div id="reset-section" class="hidden">
    <form th:action="@{/user/reset-password}" method="post">
      <div class="form-group">
        <label for="newPassword">새 비밀번호:</label><br>
        <input type="password" id="newPassword" name="newPassword" required />
      </div>
      <div class="form-group">
        <label for="confirmPassword">비밀번호 확인:</label><br>
        <input type="password" id="confirmPassword" name="confirmPassword" required />
      </div>
      <input type="hidden" id="resetEmail" name="email" />
      <button type="submit">비밀번호 변경</button>
    </form>
  </div>

  <script>
    // 이메일 폼 제출 시
    document.getElementById("emailForm").addEventListener("submit", function (event) {
      event.preventDefault();

      const email = document.getElementById("email").value;

      fetch(`/user/email/verification-requests?email=` + email, {
        method: "POST"
      }).then(response => {
        if (response.ok) {
          document.getElementById("code-section").classList.remove("hidden");
          document.getElementById("verifyEmail").value = email;
          alert("인증번호가 이메일로 전송되었습니다.");
        } else {
          alert("이메일 전송에 실패했습니다.");
        }
      });
    });

    // 인증번호 확인 폼 제출 시
    document.getElementById("verifyForm").addEventListener("submit", function (event) {
      event.preventDefault();

      const email = document.getElementById("verifyEmail").value;
      const code = document.getElementById("code").value;

      fetch(`/user/email/verification?email=${email}&code=${code}`, {
        method: "GET"
      }).then(response => {
        if (!response.ok) throw new Error("서버 오류");
        return response.json();
      }).then(data => {
        if (data.data.success === true) {
          document.getElementById("reset-section").classList.remove("hidden");
          document.getElementById("verify-status").innerText = "인증 성공!";
          document.getElementById("resetEmail").value = email;

        } else {
          document.getElementById("verify-status").innerText = "인증 실패. 올바른 인증번호를 입력해주세요.";
          document.getElementById("verify-status").classList.add("error");
        }
      }).catch(err => {
        alert("인증 요청 중 오류가 발생했습니다.");
      });
    });
  </script>

  <script th:inline="javascript">
    /* 서버에서 전달한 메시지를 alert로 출력 */
    /* [[${message}]]는 Thymeleaf가 백엔드의 모델에서 message 값을 읽어온다 */
    let message = [[${message}]];
    if (message && message.length > 0) {
      alert(message);
    }
  </script>


</body>
</html>
